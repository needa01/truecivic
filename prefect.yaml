# Prefect Deployment Configuration
# This file defines how flows are deployed and scheduled

# Prefect server/cloud configuration
name: parliament-explorer
prefect-version: 3.4.24

# Build configuration
build: null

# Pull configuration (for retrieving flow code)
pull:
  - prefect.deployments.steps.set_working_directory:
      directory: "/opt/truecivic"

# Push configuration (for storing flow code)
# push:
#   - prefect.deployments.steps.push_code_to_block:
#       block_name: truecivic-repo

# Deployment definitions
deployments:
  # Hourly bill fetching
  - name: fetch-bills-hourly
    entrypoint: src/prefect_flows/bill_flows.py:fetch_latest_bills_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    schedule:
      cron: "0 * * * *" # Every hour at minute 0
      timezone: "UTC"
    parameters:
      limit: 50
    tags:
      - production
      - bills
      - hourly
    description: "Fetch latest 50 bills every hour to keep data fresh"

  # Daily bill fetching
  - name: fetch-bills-daily
    entrypoint: src/prefect_flows/bill_flows.py:fetch_latest_bills_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    schedule:
      cron: "0 2 * * *" # Daily at 2:00 AM UTC
      timezone: "UTC"
    parameters:
      limit: 100
    tags:
      - production
      - bills
      - daily
    description: "Fetch latest 100 bills daily at 2 AM UTC"

  # Daily monitoring
  - name: monitor-daily
    entrypoint: src/prefect_flows/bill_flows.py:monitor_fetch_operations_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    schedule:
      cron: "0 3 * * *" # Daily at 3:00 AM UTC (after fetch)
      timezone: "UTC"
    parameters:
      hours_back: 24
    tags:
      - production
      - monitoring
      - daily
    description: "Monitor fetch operations daily at 3 AM UTC"

  # Hourly vote ingestion (lightweight)
  - name: fetch-votes-hourly
    entrypoint: src/prefect_flows/vote_with_records_flow.py:fetch_latest_votes_hourly_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    schedule:
      cron: "10 * * * *" # Every hour at minute 10 (offset from bills)
      timezone: "UTC"
    parameters:
      limit: 40
      start_date: null
    tags:
      - production
      - votes
      - hourly
    description: "Fetch the latest votes each hour with conservative limits"

  # Daily vote ingestion with records
  - name: fetch-votes-daily
    entrypoint: src/prefect_flows/vote_with_records_flow.py:fetch_votes_with_records_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    schedule:
      cron: "40 2 * * *" # Daily at 02:40 AM UTC
      timezone: "UTC"
    parameters:
      parliament: 45
      session: null
      limit: 150
      fetch_records: true
      start_date: null
    tags:
      - production
      - votes
      - daily
    description: "Daily vote ingestion with full record fetch and rate-aware limits"

  # Hourly debate ingestion (recent snapshots)
  - name: fetch-debates-hourly
    entrypoint: src/prefect_flows/debate_flow.py:fetch_recent_debates_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    schedule:
      cron: "20 * * * *" # Every hour at minute 20
      timezone: "UTC"
    parameters:
      limit: 20
    tags:
      - production
      - debates
      - hourly
    description: "Fetch the most recent debates hourly to keep speech data fresh"

  # Daily debates with full speech capture
  - name: fetch-debates-daily
    entrypoint: src/prefect_flows/debate_flow.py:fetch_debates_with_speeches_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    schedule:
      cron: "15 1 * * *" # Daily at 01:15 AM UTC
      timezone: "UTC"
    parameters:
      limit: 12
      parliament: null
      session: null
    tags:
      - production
      - debates
      - daily
    description: "Daily sweep of debates with speech extraction"

  # Daily committee ingestion and targeted meetings
  - name: fetch-committees-daily
    entrypoint: src/prefect_flows/committee_flow.py:fetch_all_committees_daily_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    schedule:
      cron: "0 4 * * *" # Daily at 04:00 AM UTC
      timezone: "UTC"
    tags:
      - production
      - committees
      - daily
    description: "Refresh committee metadata daily"

  - name: fetch-committee-meetings-daily
    entrypoint: src/prefect_flows/committee_flow.py:fetch_top_committees_meetings_daily_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    schedule:
      cron: "30 4 * * *" # Daily at 04:30 AM UTC
      timezone: "UTC"
    tags:
      - production
      - committees
      - daily
    description: "Fetch recent meetings for key committees each day"

  # On-demand parliament/session backfill
  - name: backfill-parliament-session
    entrypoint: src/prefect_flows/bill_flows.py:fetch_parliament_session_bills_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    # No schedule - run manually
    tags:
      - backfill
      - bills
      - manual
    description: "Backfill all bills from a specific parliament and session (manual trigger)"

  # On-demand 2025 scoped backfill (bills, votes, debates, committees)
  - name: backfill-2025-sample
    entrypoint: src/prefect_flows/backfill_flow.py:backfill_2025_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    # No schedule - triggered manually when needed
    parameters:
      bill_limit: null
      vote_limit: null
      debate_limit: null
      committee_limit: null
      meetings_limit: null
      politician_limit: null
      parliament: null
      session: null
      full: true
      start_year: null
      end_year: null
    tags:
      - backfill
      - manual
      - 2025
    description: "Run the scoped 2025 backfill (adjust limits when triggering manually)"

  # Decade-scale backfill convenience deployment
  - name: backfill-decade
    entrypoint: src/prefect_flows/backfill_flow.py:backfill_decade_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    parameters:
      bill_limit: null
      vote_limit: null
      debate_limit: null
      committee_limit: null
      meetings_limit: null
      politician_limit: null
      parliament: null
      session: null
    tags:
      - backfill
      - manual
      - decade
    description: "Backfill a decade of parliamentary data (2015-2025) with safe throttles"

  # Every-six-hour document embedding generation
  - name: generate-document-embeddings
    entrypoint: src/prefect_flows/embedding_flow.py:generate_document_embeddings_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    schedule:
      cron: "0 */6 * * *" # Every 6 hours at the top of the hour
      timezone: "UTC"
    parameters:
      limit: 200
      entity_types:
        - speech
        - debate
      language: "en"
      content_type: null
      max_words_per_chunk: 750
    tags:
      - production
      - embeddings
      - every-six-hours
    description: "Generate embeddings for newly ingested documents every 6 hours"

  # Manual Alembic migration runner
  - name: alembic-upgrade
    entrypoint: src/prefect_flows/alembic_flow.py:alembic_upgrade_flow
    work_pool:
      name: default-agent-pool
    storage:
      block: truecivic-repo
    parameters:
      revision: "head"
      config_path: "alembic.ini"
      sql: false
      tag: null
    tags:
      - maintenance
      - migrations
      - manual
    description: "Run Alembic migrations from within the Prefect/Railway environment (manual trigger)"
